<html>

<head>
    <link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/pure-min.css" integrity="sha384-UQiGfs9ICog+LwheBSRCt1o5cbyKIHbwjWscjemyBMT9YCUMZffs6UqUTd0hObXD" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Libre+Baskerville:700:400" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.5.2/randomColor.min.js"></script>

    <link rel="stylesheet" href="style.css">
     <meta name="viewport" content="width=device-width, initial-scale=1">
   </body>
</head>

<body>
    <!-- Default markup style -->

    <div id="container-intro">
        <div class="story content-wrapper" id="header">
            <h1>"Donations make the government stand up and listen, and anybody who pretends otherwise is not telling the truth."</h1>
            <a href="http://theprovince.com/opinion/dermod-travis-b-c-liberal-corporate-backers-win-a-lot-of-public-contracts">
                <h3> - Martyn Brown,  chief of staff to former premier Gordon Campbell</h3>
            </a>
            <p></p>
        </div>
        <div class="story" id="three-parties" data-lib-total="12,275,290">
            In 2016,
            <h2><svg height="70" width="70"><circle r="30" class="liberal" transform="translate(35 40)"></svg> BC Liberals raised <span class="liberal">$12,275,290 </span></h2>
            <h2><svg height="70" width="70"><circle r="20.2" class="ndp" transform="translate(35 49.8)"></svg> BC NDP raised <span class="ndp">$4,786,494</span></h2>
            <h2><svg height="70" width="70"><circle r="8.5" class="green" transform="translate(35 61.5)"></svg>BC Greens raised <span class="green">$493,495</span></h2>
        </div>
        <i class="fa fa-long-arrow-down" id="arrow-fixed" aria-hidden="true"></i>
    </div>

    <div id="container-one-percent">
        <div class="story">
            <h3>Of this, the top 1% of donors donated <span class="influence">$7,316,211</span></h3>
        </div>
        <div class="story">
          <div id="vis"></div>
          <h3 id="forty" class="fade-in">That is <span class="influence">41%</span> of donations</p>
        </div>
      </div>

      <div id="container-access">
        <div class="story">
          <h2>These donations buy access and influence</h2>
          <h3> BC's premier Christy Clark received $50,000 from the BC Liberal party for private fundraisers
            where big donors could share a table with Clark.</h3>
          <h3>Sound like a conflict of interest?</h3>
        </div>
        <div class="story">
          <p>BC's conflict of interest commissioner didn't think so, but</p>
          <h3>his son is a deputy minister in Clark's Cabinet</h3>
          <h4>and used to work for her former husband's PR firm, where <a href="https://www.desmog.ca/2014/07/24/former-enbridge-lobbyist-john-paul-fraser-named-new-head-b-c-government-communications-branch">he lobbied for pipelines</a></h4>
        </div>
        <div class="story">
          <h3> "The Liberals defend this world-class conflict of interest (...)"</h3>
          <h4 href="http://www.theglobeandmail.com/opinion/editorials/bcs-wild-west-financing-laws-need-more-than-just-a-few-tweaks/article34259523/">-Globe and Mail</h4>
        </div>
      </div>

      <div id="imperial">
        <div class="story">
            <h3> Donors to the governing Liberal party do extremely well</h3>
        </div>
        <div class="story question">
            <img src="mount-polley-breach-harsh.jpeg">Image Credit: Cariboo Regional District
            <h3>Two years after the Mount Polley tailings breach, the worst mining accident in Canadian history, <strong> no charges or fines have been levied against Imperial Metals</strong>.  In fact, <span class="influence">BC taxpayers have paid</span> for a third of the cleanup costs. What's more, Imperial Metals has been given the go-ahead to <span class="influence">open another mine</span>.</h3>
            <h4><a href="http://vancouversun.com/opinion/columnists/opinion-mount-polley-cleanup-heavily-taxpayer-subsidized">-Vancouver Sun</a></h4>
        </div>
        <div class="story answer">
            <h3>Imperial Metals has donated <span class="influence">$151,790</span> to the BC Liberals since 2005.</h3>
            <p>Murray Edwards, the controlling shareholder of the company, was an <a href="http://www.vancouversun.com/news/Major+Imperial+Metals+shareholder+held+private+fundraiser+Clark+election/10102715/story.html#ixzz3K9Ew6PRn">organizer</a> for a $1-million dollar <em>Calgary</em> fundraiser for Christy Clark's re-election bid.  He chairs or owns companies that have donated a total of $535,549 to the BC Liberals.</p>
            <!-- [{name: "Imperial Medals", amount: 151,790}, {name: "Canadian Natural Resources", amount: 223,680}, {name: "Mount Polley Mining Corp", amount: 50,220}, {name: "Ensign Drilling", amount : 15,000}, {name: "Penn West Petroleum", amount: 60,835}, {name: "Resorts of the Canadian Rockies", amount: 28,024}, {name: "Edco Capital Corp", amount: 6,000}]  -->
            <h4><a href="http://vancouversun.com/opinion/columnists/opinion-mount-polley-cleanup-heavily-taxpayer-subsidized">-Vancouver Sun</a></h4>
        </div>
      </div>
      <div id="Kinder Morgan">
        <div class="story question">
          <h3>In the past decade Kinder Morgan and tar sands producers donated <span class="influence">$771,168</span> to the BC Liberals</h3>
          <h3><a href="http://www.cbc.ca/news/canada/british-columbia/kinder-morgan-trans-mountain-1.4035305">-CBC</a></h3>
        </div>
        <div class="story answer">
          <h3>This January, the BC Liberal government approved Kinder Morgan's Trans Mountain pipeline, which will bring a 7x increase in tanker traffic from Vancouver.</h3>
        </div>
      </div>

      <div id="contracts">
        Giving money to political parties is just another way of communicating with government.
        - <a href="http://www.nationalobserver.com/2017/04/25/news/bc-road-builder-says-money-improves-communication-governments"> Jonathan Moser, spokesman for Lafarge Canada. Donated $27,942 to BC political parties between 2013 and 2016.</a>
      </div>

      <div id="power-shift">
        <h2> WE CAN CHANGE THIS </h2>

        <p> This is a close race. </p>
        <h3>Which parties promise to ban corporate and union donations</h3>
        <ul>
          <li>BC NDP - yes</li>
          <li>BC Greens - yes</li>
          <li>BC Liberals - no</li>
        </ul>

        <h1> GO VOTE </h1>
        <h2> Here's how </h3>
          <!-- How to vote -->
          <p>
            If you haven't figured things out by election day, you can still vote.
            Show up at any polling station
              with one piece of photo government ID
                with your address.
              If you don't have that, you can have a friend that lives in your same electoral district <a href="http://elections.bc.ca/2017-general-election/voter-id/vouching/"> vouch for you</a>.
            To see what other ID options you can use, check out <a href="http://elections.bc.ca/2017-general-election/voter-id/">Elections BC</a>.
          </p>

      </div>

      <div id="gotv">
      </div>

      <div id="sidenote">
        To explore more of the data yourself, checkout out <a href="http://bigmoney.dogwoodbc.ca/explore-contributions/">bigmoney.dogwoodbc.ca/explore-contributions/</a>
      </div>


    <!-- include jquery and scrollstory -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="jquery.scrollstory.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

    <script>
      var width = 700;
      var height = 600;
      var aspect = width / height;
      var xDomain = 100;
      var yDomain = 10;
      var noRows = 4;
      var radScale = 8;

      // SVG to work with
      var svg = d3.select('#vis')
        .append('svg')
        .attr('height', height)
        .attr('width', width)
        .attr("viewBox", "0 0 "+ width +" " + height +"")
        .attr("preserveAspectRatio", "xMidYMid")
        .attr("id", "chart");

      // Circle positioning function
      var circleFunc = function(circle) {
      //     console.log("circle function called");
          circle.attr('r', function(d) { return d.r})
                .attr('fill', function(d) {return d.colour || 'blue' })
                .attr('cx', function(d) { return xScale(d.x)})
                .attr('cy', function(d) { return yScale(d.y)})
                .attr('class', function(d) {return d.class})
      }

      // Reusable drawing function
      var draw = function(data) {
          // Bind self.settings.data
          var circles = svg.selectAll('circle').data(data)

          // Enter new elements
          circles.enter().append('circle').call(circleFunc)

          // Exit elements that may have left
          circles.exit().remove()

          // Transition all circles to new dself.settings.data
          svg.selectAll('circle').transition().duration(1500).call(circleFunc)
      }

      // Define data, xScale, yScale
      function generatePoints(size, number, rowLength, scale) {
        var bucketSize = size/(number*scale);
        var buckets = []
        var rowInd = 1;
        var colInd = 1;
        for(var i=0; i<number; i++) {
          rowInd = i%rowLength + 1;
          colInd = i/rowLength + 1;
          var x = rowInd;
          var y = colInd;
          buckets.push({r: Math.sqrt(bucketSize), x: x, y: y})
        }
        buckets[0].christy = true;
        return buckets;
      }

      function generate_99() {
        var element = document.getElementsByClassName('influence'),
            style = window.getComputedStyle(element[0]),
            influenceColor = style.getPropertyValue('color');
        var donors = [];
        for(var i=0; i<99; i++) {
          var color = randomColor({
            luminosity: 'dark',
            hue: 'yellow'
          });
          donors.push({class: "bottom-percent", size: 1, x: i*4%xDomain + 1, y: 5+Math.floor(i/(xDomain/noRows)), r: 1*radScale, colour: color});
        }
        i=99
        donors.push({class: "top-percent", size: 66, x: i*4%xDomain + 1, y: 5+Math.floor(i/(xDomain/noRows)), r: 1*radScale, colour: influenceColor});
        return donors;
      }


      var chart = $("#chart"),
          container = chart.parent();
      $(window).on("resize", function() {

          var targetWidth = container.width();
          chart.attr("width", targetWidth);
          chart.attr("height", Math.min(Math.round(targetWidth / aspect), Math.round(window.innerHeight*0.6)));
          console.log("resize", chart.attr("width"), targetWidth, chart.attr("height"));
          radScale = 5 + targetWidth/150;

      }).trigger("resize");

      var data_99 = generate_99();
      var data_1 = JSON.parse(JSON.stringify(data_99))
      data_1[99].r = 12.1*radScale;

      var xScale = d3.scale.linear().range([0,width]).domain([0,xDomain])
      var yScale = d3.scale.linear().range([0,height]).domain([0,yDomain])

      var update = function(value) {
        switch(value) {
          case 1:
            var data = data_99
            console.log(data_99)
            draw(data)
            break;
          case 2:
            links = []
            for(var i=0; i<98; i++) {
              links.push({source: i, target: i+1})
              links.push({source: i, target: 99})
            }
            var data = data_1

            data_1.map((v) => {
              v.x = xScale(v.x);
              v.y = yScale(v.y);
            });
            var force = d3.layout.force()
              .size([width, height])
               .nodes(data_1)
               .links(links);

            force.linkDistance((l) => {
      //         console.log(l)
              if(l.target.index === 99) {
                return 80*radScale/5 + 5;
              }
              if(l.source.index + 1 === l.target.index) {
                return -1 + 8*radScale/4;
              }
              return 10;
            });
             force.charge(function(node) {
              if (node.target === 99)  {
                return -80;
              }
              return -100;
            });
            animationStep = 20;
               data_1[99].r = 66;

            var circles = svg.selectAll('circle').data(data_1)

            svg.select('circle.top-percent').attr("r", 12.1*radScale + "")
            force.on('tick', function() {
               circles.transition().ease('linear').duration(animationStep)
              .attr('cx', function(d) { return d.x; })
              .attr('cy', function(d) { return d.y; });

              force.stop();

              // If we're animating the layout, continue after
              // a delay to allow the animation to take effect.

              if (true) {
                  setTimeout(
                        function() { force.start(); },
                    animationStep
                  );
              }
            });
            force.start()
            break;
          default:
            var data = [{x:0, y:0, r: 5}, {x:3, y:3, r: 68}]
            draw(data)
            break;
        }
      }

      var run99 = false;

      $("#container-one-percent").scrollStory({
        itementerviewport: function(ev, item) {
          if(item.index === 1 && run99 === false) {
            // item.el.css('background-color', 'red');
            update(1);
          }
          if (item.index === 1) {
            $("#forty").addClass("loaded");
          }
        }
        });

      $("#container-one-percent").on('itemfocus', function(ev, item){
        if (item.index === 1) {
            if (run99 === false) {
              update(2);
              run99 = true;
              $('#vis').attr("class", "fixed-vis");
            }

        } else {
          item.el.css('background-color', 'orange')
        }
      });

      $("#container").on('itemblur', function(ev, item){
        item.el.css('background-color', 'white');
      });
        // Instantiation
        $(function() {
                    // data
                    var parties = [{
                        party: "BC Liberals",
                        donations: "$12,234,132"
                    }, {
                        party: "BC NDP",
                        donations: "$6,234,132"
                    }];

                    $("#container").scrollStory({

                    });

                    $("#container-one-percent").scrollStory({
                      itemfocus: function(ev, item) {
                          console.log(ev, item)
                          $("#forty").addClass("loaded");
                      }
                    });

                    $("#imperial").scrollStory({
                      itemfocus: function(ev, item) {
                          console.log(ev, item)
                          $("#imperial").addClass("go-dark");
                      }
                    })
            });


    </script>

</body>

</html>
